<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TENER, VENIR, HAY QUE TEST</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-section { display: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <!-- Navbar -->
    <nav class="bg-blue-800 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold uppercase">TENER, VENIR, HAY QUE TEST</h1>
                <p class="text-xs text-blue-200">Spanish 2 • Middle of Year</p>
            </div>
            <button onclick="window.toggleTeacherModal()" class="text-xs bg-blue-900 hover:bg-blue-700 px-3 py-1 rounded transition cursor-pointer">
                <i class="fas fa-lock mr-1"></i> Teacher Access
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto p-6">
        
        <!-- Student Login Form -->
        <div id="student-login" class="bg-white p-8 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">Student Identification</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-semibold mb-2">First Name</label>
                    <input type="text" id="fname" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter your first name">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Last Name</label>
                    <input type="text" id="lname" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter your last name">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Email Address</label>
                    <input type="email" id="email" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter your school email">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Period</label>
                    <select id="period" class="w-full p-3 border rounded-lg bg-white">
                        <option>1st</option>
                        <option>A2</option>
                        <option>A4</option>
                        <option>B3</option>
                        <option>B4</option>
                        <option>5th</option>
                    </select>
                </div>
            </div>
            <button onclick="startQuiz()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition transform hover:scale-[1.01]">
                Start Exam
            </button>
        </div>

        <!-- Quiz Container (Hidden initially) -->
        <div id="quiz-container" class="hidden-section fade-in">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-blue-50 p-4 border-b border-blue-100 flex justify-between items-center">
                    <span id="student-display" class="font-semibold text-blue-800"></span>
                    <span class="text-sm text-gray-500">50 Questions</span>
                </div>
                <div id="questions-list" class="p-6 space-y-8">
                    <!-- Questions injected via JS -->
                </div>
                <div class="p-6 bg-gray-50 border-t flex justify-center">
                    <button onclick="submitExam()" class="bg-green-600 hover:bg-green-700 text-white text-lg font-bold py-3 px-12 rounded-full shadow-lg transition transform hover:-translate-y-1">
                        Submit Exam
                    </button>
                </div>
            </div>
        </div>

        <!-- Result Section (Hidden initially) -->
        <div id="result-container" class="hidden-section fade-in text-center py-10">
            <div class="bg-white p-8 rounded-xl shadow-xl max-w-2xl mx-auto">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-3xl text-green-600"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Exam Completed!</h2>
                <p class="text-gray-600 mb-6">Your score has been recorded.</p>
                
                <div class="bg-gray-100 p-4 rounded-lg mb-8">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Final Score</p>
                    <p id="final-score-display" class="text-5xl font-bold text-blue-900 mt-2">0%</p>
                </div>

                <!-- High Visibility Warning -->
                <div class="bg-red-600 border-4 border-red-800 p-6 rounded-xl text-center text-white mb-8 shadow-2xl">
                    <i class="fas fa-file-download text-5xl mb-4 text-yellow-300 animate-bounce"></i>
                    <h3 class="text-2xl font-black uppercase mb-4 tracking-wide border-b-2 border-red-400 pb-2">⚠ ACTION REQUIRED ⚠</h3>
                    <p class="text-xl font-bold leading-tight mb-2">
                        DOWNLOAD THE FILE AND SEND IT TO YOUR TEACHER!!!
                    </p>
                    <p class="text-lg">
                        Look for <code id="filename-display" class="bg-white text-red-600 px-2 py-1 rounded font-mono font-bold mx-1 text-base">result.csv</code> in your downloads folder.
                    </p>
                </div>

                <!-- Manual Download Button -->
                <div class="mb-6">
                    <p class="text-sm text-gray-500 mb-2">Did the file not download automatically?</p>
                    <button onclick="downloadResult(lastResultData)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition flex items-center justify-center mx-auto gap-2">
                        <i class="fas fa-download"></i> Download File Again
                    </button>
                </div>

                <div class="border-t pt-4">
                    <button onclick="location.reload()" class="text-blue-600 hover:text-blue-800 font-semibold underline">Start New Session</button>
                </div>
            </div>
        </div>

        <!-- Teacher Dashboard (Hidden) -->
        <div id="teacher-dashboard" class="hidden-section fade-in">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-chalkboard-teacher text-blue-600 mr-2"></i>Teacher Dashboard</h2>
                    <button onclick="logoutTeacher()" class="text-red-500 hover:text-red-700 font-medium">Logout</button>
                </div>

                <!-- Data Import -->
                <div class="bg-blue-50 border-2 border-dashed border-blue-300 rounded-xl p-8 text-center mb-8" ondragover="event.preventDefault()" ondrop="handleDrop(event)">
                    <i class="fas fa-cloud-upload-alt text-4xl text-blue-400 mb-3"></i>
                    <p class="font-semibold text-blue-900">Upload Student Results</p>
                    <p class="text-sm text-blue-600 mb-4">Drag & drop student <strong>.csv</strong> files here or click to select</p>
                    <input type="file" id="file-upload" multiple class="hidden" onchange="handleFiles(this.files)" accept=".csv">
                    <button onclick="document.getElementById('file-upload').click()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">Select Files</button>
                </div>

                <!-- Statistics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white border rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">Total Students</p>
                        <p id="stat-count" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-white border rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">Average Score</p>
                        <p id="stat-avg" class="text-3xl font-bold text-blue-600">0%</p>
                    </div>
                    <div class="bg-white border rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">Highest Score</p>
                        <p id="stat-high" class="text-3xl font-bold text-green-600">0%</p>
                    </div>
                </div>

                <!-- Top 3 Missed -->
                <div class="bg-red-50 rounded-xl p-6 mb-8 border border-red-100">
                    <h3 class="text-lg font-bold text-red-800 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Top 3 Most Missed Questions</h3>
                    <div id="missed-questions-list" class="space-y-3">
                        <p class="text-gray-500 italic">Upload data to see insights.</p>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 border-b">
                                <th class="p-4 font-semibold text-gray-600">Name</th>
                                <th class="p-4 font-semibold text-gray-600">Period</th>
                                <th class="p-4 font-semibold text-gray-600">Score</th>
                                <th class="p-4 font-semibold text-gray-600">Missed</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <!-- Rows injected JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[100]">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-96">
            <h3 class="text-lg font-bold mb-4">Teacher Access</h3>
            <input type="password" id="teacher-pwd" class="w-full border p-2 rounded mb-4" placeholder="Enter Password">
            <p id="pwd-error" class="text-red-500 text-sm mb-2 hidden">Incorrect password</p>
            <div class="flex justify-end gap-2">
                <button onclick="toggleTeacherModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                <button onclick="verifyTeacher()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Login</button>
            </div>
        </div>
    </div>

<script>
// --- Configuration ---
const TEACHER_PASSWORD = "admin"; 

// --- Quiz Data (50 Questions) ---
const quizData = [
    // PART 1: TENER CONJUGATIONS (1-10)
    { q: "Choose the correct form: Yo ___ (tener) dos hermanos.", options: ["tienes", "tengo", "tiene", "tenemos"], a: 1 },
    { q: "Choose the correct form: Tú ___ (tener) un examen mañana.", options: ["tienes", "tengo", "tenemos", "tiene"], a: 0 },
    { q: "Choose the correct form: Ella ___ (tener) una casa grande.", options: ["tengo", "tienen", "tiene", "tenemos"], a: 2 },
    { q: "Choose the correct form: Nosotros ___ (tener) clase de español.", options: ["tenemos", "tienes", "tienen", "tengo"], a: 0 },
    { q: "Choose the correct form: Ellos ___ (tener) muchos amigos.", options: ["tiene", "tienen", "tenemos", "tienes"], a: 1 },
    { q: "Choose the correct form: Usted ___ (tener) razón.", options: ["tiene", "tienes", "tengo", "tienen"], a: 0 },
    { q: "Choose the correct form: Ustedes ___ (tener) hambre.", options: ["tengo", "tienen", "tenemos", "tiene"], a: 1 },
    { q: "Choose the correct form: Mi familia ___ (tener) una casa en la playa.", options: ["tiene", "tienen", "tenemos", "tienes"], a: 0 }, // Replaced Vosotros
    { q: "Translate: 'I have a dog.'", options: ["Tengo un perro.", "Tienes un perro.", "Tiene un perro.", "Tenemos un perro."], a: 0 },
    { q: "Select the equivalent of 'We have':", options: ["Venimos", "Tienen", "Tenemos", "Tengo"], a: 2 },

    // PART 2: VENIR CONJUGATIONS (11-15)
    { q: "Choose the correct form: Yo ___ (venir) a la fiesta.", options: ["vienes", "viene", "vengo", "venimos"], a: 2 },
    { q: "Choose the correct form: Tú ___ (venir) conmigo.", options: ["vienes", "viene", "vengo", "venimos"], a: 0 },
    { q: "Choose the correct form: Nosotros ___ (venir) de la escuela.", options: ["vienen", "venimos", "vengo", "vienes"], a: 1 },
    { q: "Choose the correct form: Ellos ___ (venir) mañana.", options: ["venimos", "viene", "vienen", "vengo"], a: 2 },
    { q: "Translate: 'She comes to the party.'", options: ["Ella viene a la fiesta.", "Ella vienes a la fiesta.", "Ella vengo a la fiesta.", "Ella vienen a la fiesta."], a: 0 },

    // PART 3: TENER QUE vs HAY QUE (16-25)
    { q: "Complete: ____ (One must) estudiar mucho.", options: ["Tengo que", "Hay que", "Tienes que", "Tienen que"], a: 1 },
    { q: "Complete: Juan ____ (has to) limpiar su cuarto.", options: ["hay que", "tengo que", "tiene que", "tenemos que"], a: 2 },
    { q: "Complete: Yo ____ (have to) comer más frutas.", options: ["hay que", "tiene que", "tienen que", "tengo que"], a: 3 },
    { q: "Complete: ____ (It is necessary) beber agua.", options: ["Hay que", "Tengo que", "Tienes que", "Tiene que"], a: 0 },
    { q: "Complete: Nosotros ____ (have to) salir ahora.", options: ["tenemos que", "hay que", "tienen que", "tienes que"], a: 0 },
    { q: "Which expression is IMPERSONAL (general obligation)?", options: ["Tener que", "Hay que", "Estar que", "Ir a"], a: 1 },
    { q: "Which expression implies a SPECIFIC person has an obligation?", options: ["Hay que", "Es necesario", "Tener que", "Es importante"], a: 2 },
    { q: "Translate: 'You have to listen.' (Tú)", options: ["Hay que escuchar.", "Tienes que escuchar.", "Tengo que escuchar.", "Tiene que escuchar."], a: 1 },
    { q: "Translate: 'One must practice.'", options: ["Tiene que practicar.", "Hay que practicar.", "Tengo que practicar.", "Tienen que practicar."], a: 1 },
    { q: "Translate: 'They have to run.'", options: ["Tienen que correr.", "Hay que correr.", "Tenemos que correr.", "Tiene que correr."], a: 0 },

    // PART 4: TENER EXPRESSIONS (26-50)
    { q: "How do you say 'I am hungry'?", options: ["Soy hambre", "Estoy hambre", "Tengo hambre", "Hago hambre"], a: 2 },
    { q: "How do you say 'I am thirsty'?", options: ["Tengo sed", "Soy sed", "Estoy sed", "Hay sed"], a: 0 },
    { q: "How do you say 'I am hot'?", options: ["Tengo frío", "Tengo calor", "Soy calor", "Estoy caliente"], a: 1 },
    { q: "How do you say 'I am cold'?", options: ["Tengo frío", "Tengo calor", "Soy frío", "Estoy frío"], a: 0 },
    { q: "How do you say 'I am sleepy'?", options: ["Tengo dormir", "Tengo cama", "Tengo sueño", "Soy sueño"], a: 2 },
    { q: "How do you say 'I am in a hurry'?", options: ["Tengo rápido", "Tengo prisa", "Soy prisa", "Estoy prisa"], a: 1 },
    { q: "How do you say 'I am afraid'?", options: ["Tengo miedo", "Tengo valor", "Soy miedo", "Estoy asustado"], a: 0 },
    { q: "How do you say 'to be careful'?", options: ["Tener cuidado", "Tener cuidar", "Ser cuidado", "Estar cuidado"], a: 0 },
    { q: "How do you say 'to be right'?", options: ["Tener razón", "Tener correcto", "Ser razón", "Estar correcto"], a: 0 },
    { q: "How do you say 'to be lucky'?", options: ["Tener feliz", "Tener suerte", "Ser suerte", "Estar suerte"], a: 1 },
    { q: "Translate: 'I am 15 years old.'", options: ["Soy 15 años.", "Estoy 15 años.", "Hago 15 años.", "Tengo 15 años."], a: 3 },
    { q: "How do you say 'to be successful'?", options: ["Tener éxito", "Tener ganar", "Ser éxito", "Estar éxito"], a: 0 },
    { q: "How do you say 'to be ashamed'?", options: ["Tener pena", "Tener vergüenza", "Tener miedo", "Both A and B"], a: 3 }, 
    { q: "How do you say 'to take place'?", options: ["Tener sitio", "Tener lugar", "Tener espacio", "Ser lugar"], a: 1 },
    { q: "Translate: 'I feel like eating.'", options: ["Tengo ganas de comer.", "Tengo gusto de comer.", "Tengo deseos de comer.", "Tengo querer comer."], a: 0 },
    { q: "Translate: 'Tengo dolor de cabeza.'", options: ["I have a headache.", "I am hot.", "I am careful.", "I am lucky."], a: 0 },
    { q: "Translate: 'Ella tiene celos.'", options: ["She is jealous.", "She is cold.", "She is right.", "She is happy."], a: 0 },
    { q: "Translate: 'Tenemos confianza.'", options: ["We are confident.", "We are confused.", "We are cold.", "We are tired."], a: 0 },
    { q: "Translate: 'Tienes la culpa.'", options: ["You are lucky.", "You are guilty (at fault).", "You are right.", "You are careful."], a: 1 },
    { q: "Translate: 'Hay que tener en cuenta.'", options: ["One must ignore.", "One must take into account.", "One must count.", "One must run."], a: 1 },
    { q: "It is winter and snowing. You say:", options: ["Tengo calor.", "Tengo suerte.", "Tengo frío.", "Tengo razón."], a: 2 },
    { q: "You haven't eaten all day. You say:", options: ["Tengo sed.", "Tengo hambre.", "Tengo prisa.", "Tengo miedo."], a: 1 },
    { q: "You just won the lottery. You say:", options: ["Tengo suerte.", "Tengo miedo.", "Tengo frío.", "Tengo sueño."], a: 0 },
    { q: "It is 2:00 AM and you are yawning. You say:", options: ["Tengo prisa.", "Tengo hambre.", "Tengo sueño.", "Tengo calor."], a: 2 },
    { q: "Translate: 'I am very cold.'", options: ["Tengo mucho frío.", "Tengo muy frío.", "Soy mucho frío.", "Estoy muy frío."], a: 0 }
];

let studentData = {
    fname: "",
    lname: "",
    email: "",
    period: "",
    answers: [] 
};

let lastResultData = null;

// --- Student Flow ---

function startQuiz() {
    const f = document.getElementById('fname').value.trim();
    const l = document.getElementById('lname').value.trim();
    const e = document.getElementById('email').value.trim().toLowerCase();
    const p = document.getElementById('period').value;

    if (!f || !l || !e) {
        alert("Please enter your full name and email address.");
        return;
    }

    // Check for previous attempt using Email
    const uniqueId = `quiz_taken_${e}`;
    if (localStorage.getItem(uniqueId)) {
        alert("Access Denied: This email address has already submitted the exam.");
        return;
    }

    studentData.fname = f;
    studentData.lname = l;
    studentData.email = e;
    studentData.period = p;

    document.getElementById('student-display').innerText = `${l}, ${f} (${p})`;
    document.getElementById('student-login').classList.add('hidden-section');
    document.getElementById('quiz-container').classList.remove('hidden-section');

    renderQuestions();
}

function renderQuestions() {
    const container = document.getElementById('questions-list');
    container.innerHTML = quizData.map((q, index) => `
        <div class="mb-6 p-4 border rounded-lg hover:bg-gray-50 transition" id="q-box-${index}">
            <p class="font-semibold text-lg mb-3">${index + 1}. ${q.q}</p>
            <div class="space-y-2">
                ${q.options.map((opt, optIndex) => `
                    <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-blue-100 transition">
                        <input type="radio" name="q${index}" value="${optIndex}" class="form-radio h-5 w-5 text-blue-600">
                        <span>${opt}</span>
                    </label>
                `).join('')}
            </div>
        </div>
    `).join('');
}

function submitExam() {
    const answers = [];
    let score = 0;
    let missedIndices = [];

    for (let i = 0; i < quizData.length; i++) {
        const selected = document.querySelector(`input[name="q${i}"]:checked`);
        if (!selected) {
            alert(`You missed question ${i + 1}. Please answer all questions.`);
            document.getElementById(`q-box-${i}`).scrollIntoView({behavior: "smooth", block: "center"});
            return;
        }
        const val = parseInt(selected.value);
        answers.push(val);
        
        let isCorrect = false;
        if (Array.isArray(quizData[i].a)) {
            isCorrect = quizData[i].a.includes(val);
        } else {
            isCorrect = (val === quizData[i].a);
        }

        if (isCorrect) {
            score++;
        } else {
            missedIndices.push(i);
        }
    }

    // Mark exam as taken in localStorage using Email
    const uniqueId = `quiz_taken_${studentData.email}`;
    localStorage.setItem(uniqueId, "true");

    const finalScore = Math.round((score / quizData.length) * 100);
    const resultPayload = {
        name: `${studentData.lname}, ${studentData.fname}`,
        email: studentData.email,
        period: studentData.period,
        score: finalScore,
        rawScore: score,
        total: quizData.length,
        missed: missedIndices,
        timestamp: new Date().toISOString()
    };

    lastResultData = resultPayload;

    document.getElementById('quiz-container').classList.add('hidden-section');
    document.getElementById('result-container').classList.remove('hidden-section');
    document.getElementById('final-score-display').innerText = finalScore + "%";
    
    downloadResult(resultPayload);
}

function downloadResult(data) {
    if (!data) return; 
    
    // Updated Headers to include Email
    const headers = ["Name", "Email", "Period", "Score", "RawScore", "Total", "Timestamp", "MissedQuestionIndices"];
    const safeName = data.name.replace(/"/g, '""');
    const missedStr = data.missed.join('|');
    
    const row = [
        `"${safeName}"`,
        `"${data.email}"`,
        `"${data.period}"`,
        data.score,
        data.rawScore,
        data.total,
        `"${data.timestamp}"`,
        `"${missedStr}"`
    ];
    
    const csvContent = headers.join(",") + "\n" + row.join(",");
    const dataStr = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
    const downloadAnchorNode = document.createElement('a');
    const fileName = `Result_${studentData.lname.replace(/[^a-z0-9]/gi, '')}_${studentData.fname.replace(/[^a-z0-9]/gi, '')}.csv`;
    
    document.getElementById('filename-display').innerText = fileName;
    
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", fileName);
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

// --- Teacher Flow ---

function toggleTeacherModal() {
    const modal = document.getElementById('password-modal');
    modal.classList.toggle('hidden');
    document.getElementById('pwd-error').classList.add('hidden');
    document.getElementById('teacher-pwd').value = "";
}

function verifyTeacher() {
    const pwd = document.getElementById('teacher-pwd').value;
    if (pwd === TEACHER_PASSWORD) {
        toggleTeacherModal();
        document.getElementById('student-login').classList.add('hidden-section');
        document.getElementById('quiz-container').classList.add('hidden-section');
        document.getElementById('result-container').classList.add('hidden-section');
        document.getElementById('teacher-dashboard').classList.remove('hidden-section');
    } else {
        document.getElementById('pwd-error').classList.remove('hidden');
    }
}

function logoutTeacher() {
    location.reload();
}

window.toggleTeacherModal = toggleTeacherModal;
window.verifyTeacher = verifyTeacher;
window.logoutTeacher = logoutTeacher;

// --- Dashboard Logic ---

let classResults = [];

function handleDrop(e) {
    e.preventDefault();
    handleFiles(e.dataTransfer.files);
}

function handleFiles(files) {
    Array.from(files).forEach(file => {
        if (!file.name.toLowerCase().endsWith('.csv')) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const lines = text.trim().split('\n');
                if (lines.length < 2) return; 
                
                const rowStr = lines[1];
                const matches = rowStr.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                
                // Updated check for new CSV format (Length 8)
                if (!matches || matches.length < 8) throw new Error("Invalid CSV Format");

                const clean = (str) => str ? str.replace(/^"|"$/g, '').replace(/""/g, '"') : "";

                const res = {
                    name: clean(matches[0]),
                    email: clean(matches[1]), // Capture Email
                    period: clean(matches[2]),
                    score: parseInt(matches[3]),
                    rawScore: parseInt(matches[4]),
                    total: parseInt(matches[5]),
                    timestamp: clean(matches[6]),
                    missed: clean(matches[7]).split('|').filter(s => s !== "").map(Number)
                };

                if(!classResults.some(r => r.name === res.name && r.timestamp === res.timestamp)) {
                    classResults.push(res);
                }
                updateDashboard();
            } catch (err) {
                console.error("Error parsing file:", file.name, err);
            }
        };
        reader.readAsText(file);
    });
}

function updateDashboard() {
    const totalStudents = classResults.length;
    const avgScore = Math.round(classResults.reduce((acc, curr) => acc + curr.score, 0) / totalStudents) || 0;
    const highScore = Math.max(...classResults.map(r => r.score), 0);

    document.getElementById('stat-count').innerText = totalStudents;
    document.getElementById('stat-avg').innerText = avgScore + "%";
    document.getElementById('stat-high').innerText = highScore + "%";

    const tbody = document.getElementById('results-table-body');
    tbody.innerHTML = classResults.map(r => `
        <tr class="border-b hover:bg-gray-50">
            <td class="p-3 font-medium">${r.name}</td>
            <td class="p-3 text-gray-500">${r.period}</td>
            <td class="p-3 font-bold ${getScoreColor(r.score)}">${r.score}%</td>
            <td class="p-3 text-xs text-gray-400">${r.missed.map(i => i+1).join(', ')}</td>
        </tr>
    `).join('');

    const questionMissCounts = {};
    classResults.forEach(r => {
        r.missed.forEach(qIdx => {
            if (!isNaN(qIdx)) {
                questionMissCounts[qIdx] = (questionMissCounts[qIdx] || 0) + 1;
            }
        });
    });

    const sortedMissed = Object.keys(questionMissCounts)
        .map(key => ({ 
            index: parseInt(key), 
            count: questionMissCounts[key], 
            text: quizData[key].q 
        }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 3);

    const missedContainer = document.getElementById('missed-questions-list');
    if (sortedMissed.length > 0) {
        missedContainer.innerHTML = sortedMissed.map(item => {
            const pct = Math.round((item.count / totalStudents) * 100);
            return `
                <div class="flex items-start bg-white p-3 rounded border shadow-sm">
                    <span class="bg-red-100 text-red-800 font-bold px-2 py-1 rounded text-xs mr-3">Q${item.index + 1}</span>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800">${item.text}</p>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div class="bg-red-500 h-2 rounded-full" style="width: ${pct}%"></div>
                        </div>
                        <p class="text-xs text-right text-red-600 mt-1">${pct}% of class missed this</p>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function getScoreColor(score) {
    if(score >= 90) return 'text-green-600';
    if(score >= 70) return 'text-yellow-600';
    return 'text-red-600';
}
</script>
</body>
</html>
</html>
